{% extends "base.html" %} 

{% block title %}Database User - AbsensiPro{% endblock %} 

{% block extra_style %}
<style>
  /* Animasi list yang halus */
  .list-item-anim {
    animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    opacity: 0;
    transform: translateY(10px);
  }
  @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }

  .scroll-container {
    height: calc(100vh - 250px);
    overflow-y: auto;
    padding-right: 12px;
  }
  
  .scroll-container::-webkit-scrollbar { width: 5px; }
  .scroll-container::-webkit-scrollbar-thumb {
    background: rgba(59, 130, 246, 0.2);
    border-radius: 20px;
  }

  /* Input nama saat mode edit */
  .name-label {
    display: inline-block;
    color: #f1f5f9;
    font-size: 1rem;
    font-weight: 700;
    padding: 6px 10px;
    border-radius: 8px;
    outline: none;
    transition: all 0.2s;
    border: 1px solid transparent;
  }

  .name-label[contenteditable="true"] {
    background: rgba(30, 41, 59, 0.8);
    border: 1px solid rgba(59, 130, 246, 0.5);
    color: #60a5fa;
  }

  .user-row {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.04);
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }

  .user-row:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(59, 130, 246, 0.3);
  }
</style>
{% endblock %} 

{% block content %}
<main class="max-w-7xl mx-auto p-6 md:p-10 flex flex-col h-screen overflow-hidden">
  
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8 shrink-0">
    <div>
      <h2 class="text-3xl font-black tracking-tighter text-white uppercase">
        Database <span class="text-blue-500">User</span>
      </h2>
      <p class="text-[10px] text-slate-500 font-bold tracking-[0.2em] mt-1 uppercase">
        Total Terdaftar: {{ users|length }} Anggota
      </p>
    </div>
    
    <a href="/tambah_wajah" 
       class="flex items-center gap-3 px-6 py-3.5 rounded-xl bg-blue-600 text-white text-xs font-black transition-all hover:bg-blue-500 active:scale-95 shadow-lg shadow-blue-600/20">
       <i data-lucide="user-plus" class="w-4 h-4"></i>
       TAMBAH USER BARU
    </a>
  </div>

  <div class="bg-slate-900/40 border border-white/5 rounded-[2rem] flex flex-col shadow-2xl flex-1 overflow-hidden backdrop-blur-md">
    
    <div class="grid grid-cols-12 gap-4 px-10 py-6 border-b border-white/5 bg-white/[0.02] text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">
      <div class="col-span-2">Foto</div>
      <div class="col-span-5">Informasi Profil</div>
      <div class="col-span-2 text-center">Status</div>
      <div class="col-span-3 text-right">Manajemen</div>
    </div>

    <div class="scroll-container p-6">
      {% for user in users %}
      <div id="row-{{ user._id }}" 
           class="user-row grid grid-cols-12 gap-4 items-center px-6 py-4 rounded-2xl list-item-anim"
           style="animation-delay: {{ loop.index0 * 0.05 }}s">
        
        <div class="col-span-2">
          <div class="w-14 h-14 rounded-xl overflow-hidden border border-white/10 bg-slate-800">
              {% if user.image_preview %}
              <img src="{{ user.image_preview }}" class="w-full h-full object-cover" />
              {% else %}
              <div class="w-full h-full flex items-center justify-center text-slate-600">
                <i data-lucide="user" class="w-5 h-5"></i>
              </div>
              {% endif %}
          </div>
        </div>

        <div class="col-span-5">
          <span id="name-{{ user._id }}" class="name-label" contenteditable="false" spellcheck="false">{{ user.nama }}</span>
          <div class="mt-1 px-2.5">
            <span class="text-[9px] text-slate-500 font-mono tracking-widest uppercase">UID-{{ (user._id|string)[-8:] }}</span>
          </div>
        </div>

        <div class="col-span-2 flex justify-center">
            <span class="px-3 py-1 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-500 text-[9px] font-black uppercase tracking-widest">
                Verified
            </span>
        </div>

        <div class="col-span-3 flex justify-end gap-2">
          <button onclick="toggleEdit('{{ user._id }}')" id="btn-edit-{{ user._id }}" 
                  class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 text-slate-400 border border-white/5 hover:border-blue-500/50 hover:text-blue-400 transition-all">
             <i id="icon-edit-{{ user._id }}" data-lucide="edit-3" class="w-4 h-4"></i>
             <i id="icon-save-{{ user._id }}" data-lucide="save" class="w-4 h-4 hidden"></i>
          </button>

          <button onclick="deleteUser('{{ user._id }}')" 
                  class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 text-slate-400 border border-white/5 hover:bg-red-500/10 hover:border-red-500/50 hover:text-red-500 transition-all">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>

      </div>
      {% endfor %}
    </div>
  </div>
</main>
{% endblock %} 

{% block extra_scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  lucide.createIcons();

  // Fungsi Edit Nama
  function toggleEdit(id) {
    const label = document.getElementById(`name-${id}`);
    const btn = document.getElementById(`btn-edit-${id}`);
    const iconEdit = document.getElementById(`icon-edit-${id}`);
    const iconSave = document.getElementById(`icon-save-${id}`);
    const isEditing = label.getAttribute('contenteditable') === 'true';

    if (!isEditing) {
      label.setAttribute('contenteditable', 'true');
      label.focus();
      
      // Highlight UI saat edit
      btn.classList.add("bg-blue-600", "text-white", "border-blue-600");
      iconEdit.classList.add("hidden");
      iconSave.classList.remove("hidden");
    } else {
      saveEdit(id, label.innerText);
    }
  }

  function saveEdit(id, newName) {
    const btn = document.getElementById(`btn-edit-${id}`);
    btn.innerHTML = `<span class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>`;

    fetch(`/edit_user/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nama: newName.trim() }),
    }).then(res => {
      if(res.ok) location.reload();
      else {
        alert("Gagal memperbarui nama.");
        location.reload();
      }
    });
  }

  // Fungsi Hapus User
  function deleteUser(id) {
    if (confirm("Hapus data user ini secara permanen?")) {
      const row = document.getElementById(`row-${id}`);
      row.style.opacity = '0';
      row.style.transform = 'translateX(20px)';
      
      fetch(`/delete_user/${id}`, { method: "POST" }).then(res => {
        if(res.ok) {
            setTimeout(() => row.remove(), 300);
        } else {
            alert("Gagal menghapus.");
            location.reload();
        }
      });
    }
  }
</script>
{% endblock %}