{% extends "base.html" %}

{% block title %}Riwayat - AbsensiPro{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<style>
    /* 1. RESET & BASE THEME FULLCALENDAR */
    .fc { 
        --fc-border-color: rgba(255, 255, 255, 0.05); 
        --fc-button-text-color: #fff; 
        --fc-button-bg-color: rgba(89, 173, 255, 0.1); 
        --fc-button-border-color: rgba(89, 173, 255, 0.2); 
        --fc-button-hover-bg-color: rgba(89, 173, 255, 0.2); 
        --fc-button-active-bg-color: #59adff; 
        --fc-today-bg-color: rgba(89, 173, 255, 0.05); 
    }

    .fc-theme-standard .fc-scrollgrid { border: none !important; }
    .fc-theme-standard td, .fc-theme-standard th { border: 1px solid rgba(255, 255, 255, 0.03) !important; }

    /* Header Styling */
    .fc .fc-toolbar-title { font-size: 1.1rem !important; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; color: #59adff; }
    .fc .fc-col-header-cell-cushion { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.4); padding: 15px 0 !important; }

    /* Day Cell Styling */
    .fc-daygrid-day-number { font-family: 'Plus Jakarta Sans'; font-size: 0.8rem !important; font-weight: 600; color: rgba(255,255,255,0.3); padding: 10px !important; }
    .fc-day-today .fc-daygrid-day-number { color: #59adff !important; font-weight: 800; }

    /* 2. GLOW EFFECT UNTUK TANGGAL ABSEN */
    .has-event {
        background: radial-gradient(circle at center, rgba(16, 185, 129, 0.08) 0%, transparent 80%) !important;
        position: relative;
    }
    .has-event::after {
        content: ''; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
        width: 4px; height: 4px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981;
    }

    /* Event Bar Styling */
    .fc-v-event, .fc-h-event { background: transparent !important; border: none !important; }

    /* 3. TOOLTIP STYLING */
    #tooltip {
        position: fixed; display: none; z-index: 9999;
        background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px) saturate(180%);
        border: 1px solid rgba(16, 185, 129, 0.3); padding: 16px; border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        pointer-events: none; transform: translate(-50%, -105%); transition: opacity 0.2s;
        min-width: 220px; max-height: 300px; overflow-y: auto;
    }
    #tooltip::-webkit-scrollbar { width: 3px; }
    #tooltip::-webkit-scrollbar-thumb { background: rgba(89, 173, 255, 0.3); border-radius: 10px; }
</style>
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 min-h-[calc(100vh-100px)]">
    
    <div class="lg:col-span-8 flex flex-col">
        <div class="blue-glass p-8 h-full flex flex-col border-white/5 relative overflow-hidden">
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-blue-500/5 rounded-full blur-[100px]"></div>
            <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-emerald-500/5 rounded-full blur-[100px]"></div>
            <div id="calendar" class="flex-1"></div>
        </div>
    </div>

    <div class="lg:col-span-4 flex flex-col gap-6">
        <div class="blue-glass p-6 border-white/10 shadow-xl">
            <h3 class="font-black text-[10px] uppercase tracking-[0.3em] text-slate-500 mb-1">Log Activity</h3>
            <div class="flex items-baseline justify-between">
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold text-white tracking-tight">{{ logs|length }}</span>
                    <span class="text-xs text-slate-500 font-semibold uppercase">Total</span>
                </div>
                <span class="text-[10px] bg-blue-500/10 text-blue-400 px-2 py-1 rounded-md border border-blue-500/20 font-bold tracking-widest">{{ session.user|upper }}</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
            {% for log in logs %}
                {% if role == 'admin' or log.nama == session.user %}
                <div id="log-{{ log._id }}" class="blue-glass p-4 border-white/5 flex justify-between items-center group hover:bg-white/5 transition-all duration-300">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center border border-white/5 group-hover:border-blue-500/30 transition-all">
                            <span class="text-xs font-bold text-slate-400 group-hover:text-blue-400">{{ log.nama[0]|upper }}</span>
                        </div>
                        <div>
                            <p class="font-bold text-sm text-slate-200 group-hover:text-white transition-colors">{{ log.nama }}</p>
                            <p class="text-[9px] text-slate-500 font-medium uppercase tracking-wider">{{ log.tanggal }}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-mono text-blue-400 bg-blue-400/10 px-2 py-0.5 rounded-md border border-blue-400/20">{{ log.waktu }}</span>
                        
                        {% if role == 'admin' %}
                        <button onclick="confirmDelete('{{ log._id }}')" class="opacity-0 group-hover:opacity-100 p-1.5 text-slate-500 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</main>

<div id="tooltip">
    <div id="tooltip-content" class="flex flex-col gap-1">
        <p id="tooltip-name" class="text-sm font-bold text-white"></p>
        <div id="tooltip-time" class="text-emerald-400 font-mono text-[10px]"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // FUNGSI DELETE LOG (Hanya Admin)
    function confirmDelete(logId) {
        if (confirm("Hapus riwayat absensi ini?")) {
            fetch(`/delete_log/${logId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const el = document.getElementById(`log-${logId}`);
                    el.style.transform = "translateX(50px)";
                    el.style.opacity = "0";
                    setTimeout(() => { 
                        el.remove();
                        window.location.reload(); // Reload untuk memperbarui kalender
                    }, 300);
                } else {
                    alert("Gagal menghapus log.");
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const tooltip = document.getElementById('tooltip');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'id',
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
            events: '/api/calendar_events',
            
            eventContent: function(arg) {
                const props = arg.event.extendedProps;
                let html = '';
                
                if (props.is_admin) {
                    html = `
                        <div class="flex items-center gap-1.5 py-1 px-2 bg-blue-500/10 border border-blue-500/20 rounded-lg text-[#59adff]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <span class="text-[10px] font-black">${props.count} USER</span>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="flex items-center gap-1.5 py-1 px-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-emerald-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                            </svg>
                            <span class="text-[10px] font-black uppercase">HADIR</span>
                        </div>
                    `;
                }
                return { html: html };
            },

            eventDidMount: function(info) {
                const cell = info.el.closest('.fc-daygrid-day');
                if (cell) cell.classList.add('has-event');
            },

            eventMouseEnter: function(info) {
                const props = info.event.extendedProps;
                const nameEl = document.getElementById('tooltip-name');
                const timeEl = document.getElementById('tooltip-time');
                
                if (props.is_admin) {
                    nameEl.innerHTML = `<span class="text-blue-400 text-[10px] uppercase tracking-widest block mb-2">Daftar Kehadiran</span>`;
                    let userListHtml = '<div class="space-y-2">';
                    props.users.forEach(u => {
                        userListHtml += `
                            <div class="flex justify-between items-center gap-4 border-b border-white/5 pb-1">
                                <span class="text-white text-xs font-bold">${u.nama}</span>
                                <span class="text-[9px] font-mono text-emerald-400">${u.waktu}</span>
                            </div>
                        `;
                    });
                    userListHtml += '</div>';
                    timeEl.innerHTML = userListHtml;
                } else {
                    nameEl.innerText = props.nama || "{{ session.user }}";
                    timeEl.innerHTML = `<div class="mt-1 py-1 px-2 bg-emerald-500/10 rounded border border-emerald-500/20">Jam Absen: ${props.waktu}</div>`;
                }
                
                tooltip.style.display = 'block';
                tooltip.style.opacity = '1';
                
                const rect = info.el.getBoundingClientRect();
                tooltip.style.top = (rect.top + window.scrollY) + 'px';
                tooltip.style.left = (rect.left + (rect.width / 2)) + 'px';
            },

            eventMouseLeave: function() {
                tooltip.style.opacity = '0';
                setTimeout(() => { tooltip.style.display = 'none'; }, 200);
            }
        });
        
        calendar.render();
    });
</script>
{% endblock %}